# Split Skaffold configuration for preview deployments
# Avoids Config Connector status checking bug by separating modules

apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: preview-namespace
# Namespace module - creates namespace for preview environment
manifests:
  rawYaml:
  - ../k8s/namespace/namespace.yaml
deploy:
  kubectl:
    flags:
      apply: ["--server-side", "--force-conflicts"]
---
apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: preview-app
# Application module - deployments, services with status checking enabled
manifests:
  kustomize:
    paths:
    - ../k8s/app/resources/preview
    buildArgs:
    - --load-restrictor=LoadRestrictionsNone
deploy:
  kubectl:
    flags:
      apply: ["--server-side", "--force-conflicts"]
  statusCheck: true  # Enable status checking for app resources
---
apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: preview-gcp
# GCP Config Connector module - certificates with status checking disabled
manifests:
  rawYaml:
  - ../k8s/gcp/certificate.yaml
deploy:
  kubectl:
    flags:
      apply: ["--server-side", "--force-conflicts"]
  statusCheck: false  # Disable status checking for Config Connector resources