# GENERATED FILE - DO NOT EDIT MANUALLY
# This file is auto-generated by compliance-cli
# Source: internal/generate/templates/cloudbuild/preview.yaml.tmpl
# To make changes, edit .compliance-cli.yml and run: compliance-cli generate

steps:
# Static Analysis
- name: 'node:22-alpine'
  id: 'static-analysis'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    npm ci
    npm audit --audit-level=high && npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0 || true || true
    echo "Static analysis completed!"

# Lint Check
- name: 'node:22-alpine'
  id: 'lint-check'
  waitFor: ['static-analysis']
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    npm ci
    npx eslint . --ext .js,.jsx,.ts,.tsx
    echo "Linting passed!"

# Format Check
- name: 'node:22-alpine'
  id: 'format-check'
  waitFor: ['lint-check']
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    npm ci
    npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}" || true
    echo "Code formatting verified!"

# Run tests
- name: 'node:22-alpine'
  id: 'run-tests'
  waitFor: ['format-check']
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    npm ci
    npm run test:unit
    echo "Tests passed successfully!"

# Build the Docker image
- name: 'gcr.io/cloud-builders/docker'
  id: 'build-image'
  waitFor: ['run-tests']
  args: [
    'build',
    '-t', '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/webapp-images/webapp:preview-${COMMIT_SHA}',
    '-t', '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/webapp-images/webapp:preview-pr${_PR_NUMBER}-latest',
    '.'
  ]

# Push the Docker image
- name: 'gcr.io/cloud-builders/docker'
  id: 'push-image'
  args: ['push', '--all-tags', '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/webapp-images/webapp']

# Deploy preview environment using compliance-cli
- name: 'us-docker.pkg.dev/u2i-bootstrap/gcr.io/compliance-cli-builder:v0.9.2'
  id: 'deploy-preview'
  entrypoint: 'compliance-cli'
  args: ['preview', 'deploy', '--pr-number', '${_PR_NUMBER}']
  env:
  - 'PROJECT_ID=${_PROJECT_ID}'
  - 'REGION=${_REGION}'
  - 'COMMIT_SHA=$COMMIT_SHA'
  - 'SHORT_SHA=$SHORT_SHA'
  - 'PR_NUMBER=${_PR_NUMBER}'

# Post PR comment with preview URL
- name: 'us-docker.pkg.dev/u2i-bootstrap/gcr.io/compliance-cli-builder:v0.9.2'
  id: 'post-pr-comment'
  entrypoint: 'compliance-cli'
  args: ['pr', 'comment', '--pr-number', '${_PR_NUMBER}']
  env:
  - 'PROJECT_ID=${_PROJECT_ID}'
  - 'BUILD_ID=$BUILD_ID'
  - 'PR_NUMBER=${_PR_NUMBER}'

options:
  logging: CLOUD_LOGGING_ONLY
  
substitutions:
  _PROJECT_ID: u2i-tenant-webapp-nonprod
  _REGION: europe-west1
  _PR_NUMBER: '1'  # Default, will be overridden by trigger