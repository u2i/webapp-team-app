# Cloud Deploy Configuration for Preview Deployments
# Sequential deployment using predeploy hooks: cert → infra → app

apiVersion: deploy.cloud.google.com/v1
kind: DeliveryPipeline
metadata:
  name: webapp-preview-pipeline
  labels:
    compliance: iso27001-soc2-gdpr
    team: webapp-team
    purpose: preview
description: "Preview deploy: cert → infra → app as one unit"

serialPipeline:
  stages:
  - targetId: preview-gke
    profiles: ["app-only"]  # Only run the app profile as main deploy
    strategy:
      standard:
        verify: false
        predeploy:
          actions: ["cert-action", "infra-action"]  # Run these in order first
    deployParameters:
    - values:
        DOMAIN: ""
        PREVIEW_NAME: ""
        NAMESPACE: ""
        CERT_NAME: ""
        CERT_ENTRY_NAME: ""
        CERT_DESCRIPTION: ""
        ROUTE_NAME: ""
        API_URL: ""
        ENV: ""
        STAGE: ""
        BOUNDARY: ""
        TIER: ""
        NAME_PREFIX: ""
        SERVICE_NAME: ""

---
apiVersion: deploy.cloud.google.com/v1
kind: Target
metadata:
  name: preview-gke
  labels:
    compliance: iso27001-soc2-gdpr
    environment: preview
    data-residency: eu
description: "All-in-one preview stage with sequential deployment"

gke:
  cluster: projects/u2i-tenant-webapp/locations/europe-west1/clusters/webapp-cluster
  
executionConfigs:
- usages: [RENDER, DEPLOY, PREDEPLOY]
  serviceAccount: cloud-deploy-sa@u2i-tenant-webapp.iam.gserviceaccount.com
  artifactStorage: gs://u2i-tenant-webapp-deploy-artifacts