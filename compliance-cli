#!/usr/bin/env bash
# Wrapper for compliance-cli that uses the pre-built Docker image
set -e

# Pre-built compliance-cli image
COMPLIANCE_CLI_IMAGE="${COMPLIANCE_CLI_IMAGE:-gcr.io/u2i-bootstrap/compliance-cli-builder:latest}"

# Default values
PROJECT_ID="${PROJECT_ID:-u2i-tenant-webapp-nonprod}"
REGION="${REGION:-europe-west1}"

# Path to local compliance source (for development)
COMPLIANCE_SOURCE_DIR="../compliance"

# Check if we should use local source (for compliance-cli development)
if [ -d "$COMPLIANCE_SOURCE_DIR" ] && [ -f "$COMPLIANCE_SOURCE_DIR/go.mod" ] && [ "${USE_LOCAL_SOURCE:-}" = "true" ]; then
    echo "Using local compliance source (USE_LOCAL_SOURCE=true)" >&2
    (cd "$COMPLIANCE_SOURCE_DIR" && go run cmd/deploy/main.go cmd/deploy/generate.go cmd/deploy/validate.go "$@")
else
    # Use the pre-built Docker image
    docker run --rm \
        -v "$(pwd):/workspace" \
        -w /workspace \
        -v "${HOME}/.config/gcloud:/root/.config/gcloud" \
        -e "PROJECT_ID=${PROJECT_ID}" \
        -e "REGION=${REGION}" \
        "${COMPLIANCE_CLI_IMAGE}" \
        compliance-cli "$@"
fi